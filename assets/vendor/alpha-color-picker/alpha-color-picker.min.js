(function(window, document){
    'use strict';
    function AlphaColorPicker(el){
        if (!(this instanceof AlphaColorPicker)) return new AlphaColorPicker(el);
        this.el = el;
        this.callbacks = { change: [] };
        this._bind();
    }
    AlphaColorPicker.prototype._bind = function(){
        var self = this;
        // find associated opacity range if present
        var wrapper = self.el.closest ? self.el.closest('.esi-alpha-picker') : null;
        var opacity = null;
        if (wrapper) {
            opacity = wrapper.querySelector('.esi-alpha-opacity');
        }
        function trigger(){
            var hex = self.el.value || '#000000';
            var alpha = 1;
            if (opacity) {
                var v = parseInt(opacity.value,10);
                if (!isNaN(v)) alpha = Math.max(0, Math.min(100, v))/100;
            }
            var payload = { hex: hex, alpha: alpha };
            (self.callbacks.change||[]).forEach(function(cb){ try{ cb(payload); }catch(e){} });
        }
        self.el.addEventListener('input', trigger);
        if (opacity) opacity.addEventListener('input', trigger);
    };
    AlphaColorPicker.prototype.on = function(evt, cb){ if (!this.callbacks[evt]) this.callbacks[evt]=[]; this.callbacks[evt].push(cb); };
    // expose
    window.AlphaColorPicker = AlphaColorPicker;
})(window, document);
